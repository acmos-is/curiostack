kms:
  location: us-central1
  keyring: cloudbuild
  key: github
encryptedWebhookSecret: CiQAxdYgHJB9AXKH4i4YKOyXwXUX0DRhALZPAhRCKgP3nnDFPmkSPQA/OpLBgpyFTL5Q76v7oNq3Vse8N8KMeK/MGucW+Ox4H0aNIFegcX23miuYPzug3T0NQ5sQm0YddvA9dAk=
repos:
  curioswitch/curiostack:
    encryptedGithubToken: CiQAxdYgHEoOUqReR+fSuUBil5DON+3hhzaHavInF11ViVXfkgESUQA/OpLBqfATDj0jSQWWIS3cW5VUBEcZTHx6NfSAOwO1h2i8vyoq8euBNPOhLAZBnN45sj4khnNLXUxMCATTecPJ1Nna7DBcFXEKRth9Zq93dg==
    cloudbuild:
      steps:
        - id: fetch-source
          name: gcr.io/cloud-builders/gcloud
          entrypoint: bash
          args:
            - '-c'
            - |
              echo 'echo $$GITHUB_TOKEN' > /tmp/cloudbuild-github-pass.sh && \
              chmod +x /tmp/cloudbuild-github-pass.sh && \
              git init && \
              git fetch --no-tags --progress $_REPOSITORY_URL +$_OTHER_BRANCH_REMOTE_REF:$_OTHER_BRANCH_LOCAL_REF +$_BASE_BRANCH_REMOTE_REF:$_BASE_BRANCH_LOCAL_REF && \
              git config remote.origin.url $_REPOSITORY_URL && \
              git config user.name cloudbuild && \
              git config user.email cloudbuild@example.com && \
              git checkout -f $_OTHER_BRANCH_LOCAL_REF && \
              git merge --no-ff --no-edit --no-progress $_BASE_BRANCH_LOCAL_REF && \
              MERGE_REV=$(git rev-parse HEAD^{commit}) && \
              git checkout -f $_BASE_BRANCH_LOCAL_REF && \
              git merge --no-ff --no-edit --no-progress $$MERGE_REV && \
              MERGE_REV=$(git rev-parse HEAD^{commit}) && \
              git checkout -f $$MERGE_REV
          env:
            - GIT_ASKPASS=/tmp/cloudbuild-github-pass.sh
          secretEnv:
            - GITHUB_TOKEN
        - id: build-all
          name: gcr.io/$PROJECT_ID/java-cloud-builder
          entrypoint: ./gradlew
          args:
            - continuousTest
            - '--stacktrace'
            - '--no-daemon'
          env:
            - CI=true
      timeout: 60m
      secrets:
        - kmsKeyName: projects/curioswitch-cluster/locations/us-central1/keyRings/cloudbuild/cryptoKeys/github
          secretEnv:
            GITHUB_TOKEN: CiQAxdYgHEoOUqReR+fSuUBil5DON+3hhzaHavInF11ViVXfkgESUQA/OpLBqfATDj0jSQWWIS3cW5VUBEcZTHx6NfSAOwO1h2i8vyoq8euBNPOhLAZBnN45sj4khnNLXUxMCATTecPJ1Nna7DBcFXEKRth9Zq93dg==
